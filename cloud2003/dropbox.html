<!--
@Author: John Isaacs <john>
@Date:   29-Mar-172017
@Filename: dropbox.html
@Last modified by:   john
@Last modified time: 11-Apr-172017
-->



<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  </head>
  <body>
    <button type="button" id="view">refresh tasks</button>
    <div id='tasks'></div>
    <button type="button" id="auth">Authenticate with Dropbox</button>
    <input type='text' id="taskbox" placeholder='Tasks'>
    <script>

var client;
var datastore;

    $(function() {

      client = new Dropbox.Client({key: 'inets6ft9teagsg'});
        console.log("authenticating")
        //hide the ui elements we can't use yet and show the authenticate button
        $('#taskbox').hide();
        $('#tasks').hide();
        $('#view').hide();
        $('#auth').click(client.authenticate());

        // Try to finish OAuth authorization.
        client.authenticate({interactive: false}, function (error) {
            if (error) {
                alert('Authentication error: ' + error);
            }
        });

        // check if we have a authenticated client
        if (client.isAuthenticated()) {
            console.log("Showing Interface/UI")
            // Client is authenticated. Display UI.
            $('#taskbox').show();
            $('#tasks').show();
            $('#view').show();
            $('#auth').hide();
            getDataStore();
        }
      });

      //function to connect to our data store
      function getDataStore(){
        console.log("getting datastore from dropbox");
        //get the datastore from the client (ie thie users dropbox)



            //when the user hits enter
            $('#taskbox').keypress(function (e) {
              if (e.keyCode == 13) {
                console.log("pushing to dropbox datastore");
                //access or create a table called "tasks"
                client.writeFile("tasks.txt", $('#taskbox').val() + "\n", function(error, stat) {
                  if (error) {
                    return showError(error);  // Something went wrong.
                  }
                    alert("File saved as revision " + stat.versionTag);
                });
                //finally clear the textbox
                $('#taskbox').val('');
              }
            });
            //refresh the tasks on the screen
            $('#view').click(function (e) {
              console.log("reading from dropbox datastore");
              client.readFile("tasks.txt", function(error, data) {
                if (error) {
                  return showError(error);  // Something went wrong.
                }
                alert(data);  // data has the file's contents
                console.log(data);
              });

            });

      }
    </script>
  </body>
</html>
